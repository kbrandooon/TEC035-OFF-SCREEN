-- Template for a Supabase PostgreSQL function to sync user roles to JWT claims
-- This increases RLS performance by avoiding joins within the policy itself.

/**
 * Syncs user roles from public.user_roles to auth.users.raw_app_meta_data
 * Place this in your database migrations.
 */
CREATE OR REPLACE FUNCTION public.handle_role_sync()
RETURNS trigger AS $$
DECLARE
  role_name text;
BEGIN
  -- Fetch the role name associated with the user
  -- Note: This assumes a single role per user. Adjust if many-to-many.
  SELECT r.name INTO role_name
  FROM public.user_roles ur
  JOIN public.roles r ON ur.role_id = r.id
  WHERE ur.user_id = NEW.user_id;

  -- Update the auth.users table with the new role in app_metadata
  UPDATE auth.users
  SET raw_app_meta_data = 
    coalesce(raw_app_meta_data, '{}'::jsonb) || 
    jsonb_build_object('role', role_name)
  WHERE id = NEW.user_id;

  RETURN NEW;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Trigger to run on role assignment
-- CREATE TRIGGER on_role_change
-- AFTER INSERT OR UPDATE ON public.user_roles
-- FOR EACH ROW EXECUTE FUNCTION public.handle_role_sync();
